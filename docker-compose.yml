version: '3.8'

services:
  whatsapp-bot:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: whatsapp-bot-api
    restart: unless-stopped
    ports:
      - "${SERVER_PORT:-8080}:8080"
    environment:
      - SERVER_PORT=8080
      - SERVER_READ_TIMEOUT=15s
      - SERVER_WRITE_TIMEOUT=15s
      - SERVER_IDLE_TIMEOUT=60s
      - SERVER_SHUTDOWN_TIMEOUT=10s
      - MAX_UPLOAD_SIZE=52428800
      - WHATSAPP_SESSION_KEY=${WHATSAPP_SESSION_KEY:-default-session}
      - WHATSAPP_DEFAULT_COUNTRY=${WHATSAPP_DEFAULT_COUNTRY:-55}
      - WHATSAPP_QR_GENERATE=${WHATSAPP_QR_GENERATE:-true}
      - WHATSAPP_RECONNECT_DELAY=5s
      - API_TOKEN=${API_TOKEN}
      - SESSION_KEY=${SESSION_KEY}
      - DB_DRIVER=sqlite3
      - DB_DSN=file:/app/data/whatsapp.db?_foreign_keys=on
    volumes:
      - whatsapp-data:/app/data
    networks:
      - whatsapp-network
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8080/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

volumes:
  whatsapp-data:
    driver: local

networks:
  whatsapp-network:
    driver: bridge
